# Intelligent Routing in Booker

Booker now supports intelligent routing between local book content and global web search based on book metadata. This document explains how the routing system works and how to use it.

## Overview

The routing system uses book metadata (generated by `profile_book.py`) and an LLM router to intelligently decide how to answer questions:

- **LOCAL**: Answer can be found in the book content
- **GLOBAL**: Question requires information beyond the book (web search)
- **REJECT**: Question is off-topic or inappropriate

## Components

### 1. Book Profiling (`scripts/profile_book.py`)

Generates metadata from existing ingested books:

```bash
# Standalone usage
python scripts/profile_book.py --book-id "MyBook" --db-path "library/MyBook/build/db/booker.db" --llm-summary

# Via ingestion (recommended)
python -m booker.ingest_book --book-id "MyBook" --profile
```

**Generated metadata** (`library/MyBook/book_meta.json`):
```json
{
  "title": "Introduction to Machine Learning",
  "pub_year": 2020,
  "abstract": "A comprehensive guide to ML algorithms...",
  "topics": ["machine learning", "neural networks", "data science"],
  "not_covered": [],
  "min_year": 1950,
  "max_year": 2020,
  "pages": 300
}
```

### 2. Automatic Routing

**No environment configuration needed!** The system automatically enables intelligent routing when book metadata is present.

### 3. Routing Logic

When metadata is present:

1. Retrieve relevant chunks from the book
2. Call LLM router with question, chunks, and metadata
3. Route based on decision:
   - **LOCAL** → `answer_from_chunks()` 
   - **GLOBAL** → `answer_from_web()`
   - **REJECT** → Out-of-scope message

When metadata is absent:
- Use legacy local-only behavior (backward compatibility)
- Answer from book chunks only

## Usage Examples

### Basic Usage (Same API)

```python
from booker.qa import answer_question
from booker.retriever import BookerRetriever

retriever = BookerRetriever(db_path, index_path)
result = answer_question("What is machine learning?", retriever, book_id="ml_book")
print(result["answer"])
```

### Check Routing Decision

```python
# The result includes routing information
print(result.get("search_type"))  # "local", "web", or None
```

### Generate Book Profile

```python
# Option 1: During ingestion
python -m booker.ingest_book --book-id "MyBook" --profile

# Option 2: Standalone script
python scripts/profile_book.py --book-id "MyBook" --db-path "path/to/db" --llm-summary
```

## Routing Examples

### LOCAL Routing
**Question**: "What are neural networks?" (covered in book)
**Decision**: LOCAL
**Response**: Answer from book chunks with citations

### GLOBAL Routing  
**Question**: "What happened in AI research in 2023?" (after book's max_year)
**Decision**: GLOBAL
**Response**: Web search results with LLM synthesis

### REJECT Routing
**Question**: "What's the weather today?" (completely off-topic)
**Decision**: REJECT  
**Response**: "Your question appears to be outside the scope..."

## Configuration

### Settings

In `booker/settings.py`:

```python
# Similarity threshold for legacy mode (when no metadata)
LOCAL_THRESHOLD = 0.3
```

**Note**: No environment flags needed! Routing automatically enables when metadata is present.

### Book Metadata Schema

See `booker/models.py` for the complete `BookMeta` Pydantic model:

```python
class BookMeta(BaseModel):
    title: str
    pub_year: Optional[int] = None
    abstract: str  # Max 120 words
    topics: List[str] = []
    not_covered: List[str] = []
    min_year: Optional[int] = None
    max_year: Optional[int] = None  
    pages: Optional[int] = None
```

## Testing

Run the routing tests:

```bash
# All routing tests
pytest tests/test_routing.py -v

# Profile book tests
pytest tests/test_profile_book.py -v

# Integration tests
pytest tests/ -k "routing or profile" -v
```

## Deployment Considerations

### Production Deployment

1. **Generate metadata** for existing books (this automatically enables routing):
   ```bash
   for book in library/*/; do
     book_id=$(basename "$book")
     python scripts/profile_book.py --book-id "$book_id" --db-path "$book/build/db/booker.db" --llm-summary
   done
   ```

2. **Update ingestion workflows** to include `--profile` flag:
   ```bash
   python -m booker.ingest_book --book-id "NewBook" --profile
   ```

### Security Considerations

- **Metadata-gated routing** - web search only enabled when metadata exists
- **LLM routing** - adds layer of intelligence before web search
- **Graceful fallbacks** - system continues working if components fail

## Troubleshooting

### Metadata Not Found
- Ensure `book_meta.json` exists in `library/{book_id}/`
- Check file permissions and JSON syntax
- Run profiling script manually to regenerate

### Router Returning Wrong Decisions
- Check LLM model performance and prompts
- Verify book metadata quality (topics, year ranges)
- Test with different question types

### Web Search Not Working
- Ensure book metadata exists (`book_meta.json` in book directory)
- Check web search implementation in `booker/web_search.py`
- Implement actual search API (currently placeholder)

### Performance Issues
- Profile book script can be slow for large books
- Consider running profiling offline/batch
- Cache metadata and avoid regeneration

## Future Enhancements

1. **Better Web Search**: Integrate real search APIs (Google, Bing, DuckDuckGo)
2. **Smarter Routing**: Fine-tune router prompts and decision logic  
3. **Hybrid Answers**: Combine local and web sources in single response
4. **User Feedback**: Learn from user corrections to improve routing
5. **Caching**: Cache web search results and routing decisions
6. **Analytics**: Track routing patterns and success rates 